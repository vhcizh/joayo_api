# 워크플로우 이름
name: CI/CD

# 시작 조건 : 'master'에 푸시할 때마다
on:
  push:
    branches: [master]

jobs:
  build:
    runs-on: ubuntu-latest # 실행환경 지정

    # GitHub Secrets에서 환경 변수 사용
    env:
      JWT_SECRET_KEY: ${{ secrets.JWT_SECRET_KEY }} # JWT 비밀키
      EC2_USER: ${{ secrets.EC2_USER }}  # EC2 사용자 이름
      EC2_HOST: ${{ secrets.EC2_HOST }}  # EC2 호스트 IP
      EC2_KEY: ${{ secrets.EC2_KEY }}  # EC2 SSH 키
      DB_PASSWORD: ${{ secrets.DB_PASSWORD }} # DB 접속 암호
      KEY_STORE_PASSWORD: ${{ secrets.KEY_STORE_PASSWORD }} # KEY STORE 암호
      REMOTE_PATH: ${{ secrets.REMOTE_PATH }} # EC2 서버 배포 경로

    # 실행 스텝 지정
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up JDK 11
        uses: actions/setup-java@v3
        with:
          distribution: 'zulu'
          java-version: '11'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build with Gradle
        run: ./gradlew clean build

      # JAR 파일을 EC2 서버로 복사
      - name: Copy JAR to EC2
        run: |
          scp -i $EC2_KEY -o StrictHostKeyChecking=no build/libs/*.jar $EC2_USER@$EC2_HOST:$REMOTE_PATH
